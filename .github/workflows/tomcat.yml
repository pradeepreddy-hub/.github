name: Economic time app
on: 
  push:
    branches: [main]
  pull_request:
    
jobs:
  prerequisites:
    runs-on: ubuntu-latest

    steps:
      - name: checkout code
        uses: action\checout@v4

      - name: set up jdk 17
        uses: actions\setup-java@v4
        with:
         java-version: '17'
         distribution: 'temurin'
         cache: 'maven'

  build:
    runs-on: ubuntu-latest
    needs:  prerequisites
    steps:
      - name: checkout code
        uses: actuions\checkout@v4
      - name: set up jdk 17
        uses: actions\setup-java@v4
        with:
          version: '17'
          distribution: 'temurin'
          cache: 'maven'
      - name: build war file
        run: mvn clean package
      - name: upload war to artifact
        uses: actions\upload-artifact@v4
        with:
          name: economic-time-app
          path: target/*.war

  run:
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: download war from artifact
        uses: actions\download-artid=fact@v4
        with:
          name: economic-time-app
          path: ./war

      - name: install tomcat10
        run: |
          wget https://archive.apache.org/dist/tomcat/tomcat-10/v10.1.27/bin/apache-tomcat-10.1.27.tar.gz
          tar -xvzf apache-tomcat-10.1.27.tar.gz 
          mv apache-tomcat-10.1.27 tomcat10
          chmod +x tomcat10/bin/*.sh

      - name: deploy war to tomcat10
        run: |
          cp ./war/*.war tomcat10/webapps/
          nohup tomcat10/bin/startup.sh &
          sleep 30

      - name: status check
        run: |
          curl -I http://localhost:8080/economic-time-app/ || true

      - name: verify app content
        run: |
          response=$(curl -s http://localhost:8080/economic-time-app/)
          echo "$response" | grep "Economic Time Application" || true
          echo "$response" | grep "live news catagories" || true
          echo "$response" | grep "top head lines" || true
          tomcat10 /bin/shutdown.sh       
